{% extends 'base.html' %}
{% block title %}Items - Stationery Shop{% endblock %}
{% block content %}
<div class="page-header d-flex align-items-center justify-content-between mb-4">
  <div class="d-flex align-items-center gap-3">
    <div class="icon-blob bg-gradient-primary d-flex align-items-center justify-content-center">
      <span class="material-symbols-outlined">list_alt</span>
    </div>
    <div>
      <div class="text-secondary small mb-1">Inventory</div>
      <h1 class="h4 mb-0">Items</h1>
    </div>
  </div>
  <a href="{{ url_for('item_new') }}" class="btn btn-primary">Add Item</a>
</div>

<div class="card card-glass mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" method="get" action="{{ url_for('items') }}">
      <div class="col-md-4">
        <label class="form-label">Search</label>
        <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="Item or dealer">
      </div>
      <div class="col-md-3">
        <label class="form-label">Sort by</label>
        <select class="form-select" name="sort">
          {% for k in ['SNo','ItemName','NameOfDealer','CostPrice','SellingPrice','Profit','Loss','GST','StockBought','StockSold','StockRemaining','DateOfPurchase'] %}
          <option value="{{ k }}" {% if sort_by==k %}selected{% endif %}>{{ k }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Direction</label>
        <select class="form-select" name="dir">
          <option value="asc" {% if sort_dir=='asc' %}selected{% endif %}>Ascending</option>
          <option value="desc" {% if sort_dir=='desc' %}selected{% endif %}>Descending</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Per page</label>
        <select class="form-select" name="per">
          {% for n in [10,20,50,100] %}
          <option value="{{ n }}" {% if per_page==n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-1">
        <button class="btn btn-outline-primary w-100" type="submit">Apply</button>
      </div>
    </form>
  </div>
</div>

<div class="card card-glass">
  <div class="card-body p-0">
<div class="table-responsive ">
  <table class="table table-striped align-middle theme-text">
    <thead>
      <tr>
        <th>SNo</th>
        <th>Item Name</th>
        <th>Dealer</th>
        <th>Cost</th>
        <th>Selling</th>
        <th>Profit</th>
        <th>Loss</th>
        <th>GST</th>
        <th>Bought</th>
        <th>Sold</th>
        <th>Remaining</th>
        <th>Date</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for i in items %}
      <tr>
        <td>{{ i.SNo }}</td>
        <td>{{ i.ItemName }}</td>
        <td>{{ i.NameOfDealer }}</td>
        <td>{{ '%.2f'|format(i.CostPrice) }}</td>
        <td>{{ '%.2f'|format(i.SellingPrice) }}</td>
        <td>{{ '%.2f'|format(i.Profit or 0) }}</td>
        <td>{{ '%.2f'|format(i.Loss or 0) }}</td>
        <td>{{ '%.2f'|format(i.GST) }}</td>
        <td>{{ i.StockBought }}</td>
        <td>{{ i.StockSold }}</td>
        <td>{{ i.StockRemaining }}</td>
        <td>{{ i.DateOfPurchase }}</td>
        <td class="text-end">
          <div class="btn-group btn-group-sm">
            <a class="btn btn-outline-secondary" href="{{ url_for('item_edit', sno=i.SNo) }}">Edit</a>
            <form method="post" action="{{ url_for('item_delete', sno=i.SNo) }}" class="delete-form d-inline">
              <button class="btn btn-outline-danger" type="button" onclick="return confirmDelete(this)">Delete</button>
            </form>
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="13" class="text-center text-muted">No items yet</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
  </div>
  </div>

{% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
<nav aria-label="Items pagination" class="mt-3">
  <ul class="pagination">
    <li class="page-item {% if page<=1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('items', q=q, sort=sort_by, dir=sort_dir, per=per_page, page=page-1 if page>1 else 1) }}">Previous</a>
    </li>
    <li class="page-item disabled"><span class="page-link">Page {{ page }} of {{ total_pages }}</span></li>
    <li class="page-item {% if page>=total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('items', q=q, sort=sort_by, dir=sort_dir, per=per_page, page=page+1 if page<total_pages else total_pages) }}">Next</a>
    </li>
  </ul>
  <div class="text-secondary small">Total: {{ total }}</div>
</nav>

<section id="bills" class="mt-5">
  <h2 class="h4">Bills</h2>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-primary" href="{{ url_for('bill_all') }}">All Items Bill</a>
    <a class="btn btn-primary" href="{{ url_for('sell') }}" onclick="return showSellDialog(event)">Generate Bill</a>
    <form class="d-flex gap-2" action="{{ url_for('bill_single', sno=0) }}" method="get" onsubmit="this.action=this.action.replace('/0', '/' + this.querySelector('input').value); return true;">
      <input class="form-control form-control-sm" placeholder="SNo" type="number" min="1" required>
      <button class="btn btn-outline-secondary" type="submit">Single Item Bill</button>
    </form>
  </div>
</section>
<script>
function showSellDialog(e){
  e.preventDefault();
  const form = document.createElement('form');
  form.method='post';
  form.action='{{ url_for('sell') }}';
  form.innerHTML = `
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Item Name</label>
        <input class="form-control" type="text" name="ItemName" required placeholder="Enter item name">
      </div>
      <div class="col-md-6">
        <label class="form-label">Dealer</label>
        <input class="form-control" type="text" name="NameOfDealer" placeholder="Enter dealer name">
      </div>
      <div class="col-md-4">
        <label class="form-label">Quantity</label>
        <input class="form-control" type="number" name="Quantity" min="1" step="1" value="1" required>
      </div>
    </div>`;
  const submitBtn = document.createElement('button');
  submitBtn.type='button'; submitBtn.className='btn btn-primary'; submitBtn.textContent='Generate';
  const cancelBtn = document.createElement('button');
  cancelBtn.type='button'; cancelBtn.className='btn btn-outline-secondary'; cancelBtn.textContent='Cancel';
  cancelBtn.addEventListener('click',()=>document.querySelector('#appModal .btn-close').click());
  const modal = showDialog({
    title:'Generate Bill',
    bodyHtml: form.outerHTML,
    footerButtons:[cancelBtn, submitBtn]
  });
  submitBtn.addEventListener('click', async ()=>{
    const modalEl = document.getElementById('appModal');
    const f = modalEl.querySelector('form');
    const data = Object.fromEntries(new FormData(f).entries());
    const res = await fetch('{{ url_for('sell') }}', { method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(data) });
    const json = await res.json();
    if(!json.ok){
      modalEl.querySelector('#appModalBody').insertAdjacentHTML('afterbegin', `<div class="alert alert-danger mb-2">${json.error||'Failed'}</div>`);
      return;
    }
    const r = json.receipt;
    const receiptHtml = `
      <div class="d-flex justify-content-between"><span class="text-secondary">Time</span><span>${r.time}</span></div>
      <div class="d-flex justify-content-between"><span class="text-secondary">SNo</span><span>${r.sno}</span></div>
      <div class="d-flex justify-content-between"><span class="text-secondary">Item</span><span>${r.name}</span></div>
      <div class="d-flex justify-content-between"><span class="text-secondary">Qty</span><span>${r.qty}</span></div>
      <div class="d-flex justify-content-between"><span class="text-secondary">Unit Price</span><span>${r.unit_price.toFixed(2)}</span></div>
      <hr/>
      <div class="d-flex justify-content-between h5"><span>Total</span><span>${r.total.toFixed(2)}</span></div>
      <div class="text-secondary small">Remaining stock: ${r.remaining}</div>
    `;
    modalEl.querySelector('#appModalTitle').textContent='Receipt';
    modalEl.querySelector('#appModalBody').innerHTML = receiptHtml;
    const printBtn = document.createElement('button'); printBtn.type='button'; printBtn.className='btn btn-outline-primary'; printBtn.textContent='Print';
    printBtn.addEventListener('click',()=>window.print());
    const closeBtn = document.createElement('button'); closeBtn.type='button'; closeBtn.className='btn btn-primary'; closeBtn.textContent='Close';
    closeBtn.addEventListener('click',()=>document.querySelector('#appModal .btn-close').click());
    const footer = modalEl.querySelector('#appModalFooter'); footer.innerHTML=''; footer.append(printBtn, closeBtn);
  });
  return false;
}

function confirmDelete(btn){
  const form = btn.closest('form');
  const body = document.createElement('div');
  body.innerHTML = `<p>Are you sure you want to delete this item?</p>`;
  const yes = document.createElement('button'); yes.type='button'; yes.className='btn btn-danger'; yes.textContent='Delete';
  yes.addEventListener('click', ()=>{ form.submit(); });
  const no = document.createElement('button'); no.type='button'; no.className='btn btn-outline-secondary'; no.textContent='Cancel';
  no.addEventListener('click',()=>document.querySelector('#appModal .btn-close').click());
  showDialog({ title:'Confirm Deletion', bodyHtml: body.outerHTML, footerButtons:[no, yes] });
  return false;
}
</script>
{% endblock %}


